---
title: bchanでアスキーアートを完璧に見たいなあ
date: 2012-03-25 21:39:33
tags: bchan, 
---
と、思ったのでここしばらく、TrueTypeフォントと格闘してました。

つーか、checkSumAdjustmenはどうしてあんな仕様なんだろう……。

IPAモナーフォントを突っ込むだけじゃうまくいかない、ってのは前々から分かってたんであれこれ調べてたんですよ。

どーも、インストールしたはずのフォントのJIS X 0208領域のフォントが表示されないなーって思って、TrueTypeのデータを直接いじくりまわすこと一ヶ月……はちょっと大げさか。まあ2～3週間。

とりあえず、TrueTypeのnameテーブルが原因ってのがわかって一安心。

「システム環境設定」→「書体」→「詳細情報」で出てくるフォント名はそのnameテーブルにあるやつなんだけど、IPAモナーフォントだと、超漢字で必要な情報が足りないみたい。

もとのIPAフォントだと大丈夫なんだけどね。

えーと、nameテーブル内には、nameレコードってのが複数あって、各レコードにはplatformIDとencodingIDとlanguageIDとnameID、そして文字列への情報があって。
で、platformIDとencodingIDとlanguageIDが同一のレコードでひとまとめにして扱うみたいね。nameIDでそのレコードの持つ文字列が何なのか(フォント名、フォントクラス名、プログラム名、Copyrightなどなど)を指定することになっているわけで。で、それがいくつか欠けていたのでうまく動作しなかったっぽい。

んで、足したらうまく行きました、と。

nameIDの0から5まで揃ってる必要があるようです。で揃ってるやつのlanguageIDで、有効な文字コードの範囲が決まるっぽい。この辺の詳細までは調べてないけどね。

結果だけ見たらまあ簡単なんだけど、そこにたどりつくまでに、cmapテーブルのエンコード変えてみたり、headテーブルいじくり回してみたり、回り道が大変だったのねー。

ただ、うまく行ったらあとは割と簡単。半角で特殊な処理が必要かなーって思ってたけど、そこは超漢字のフォントマネージャがうまくやってくれてたぜー。

あとスペースの間隔がなんかおかしいので、そこはbchan側で適当にいじる必要があったけど。

で、その結果。

<a href="http://ornse01.b.sourceforge.jp/files/2012/03/aa_bchan_240325.png"><img src="http://ornse01.b.sourceforge.jp/files/2012/03/aa_bchan_240325.png" alt="現時点のアスキーアート表示結果" width="543" height="95" class="alignnone size-full wp-image-80" /></a>

結構いいよね。軽く調節しただけのわりに、かなりいい感じかと。

期待動作は以下。自分の環境のFirefoxでIPAモナーPゴシックです。

<a href="http://ornse01.b.sourceforge.jp/files/2012/03/aa_expected_240325.png"><img src="http://ornse01.b.sourceforge.jp/files/2012/03/aa_expected_240325.png" alt="期待動作となるアスキーアート表示結果" width="550" height="99" class="alignnone size-full wp-image-79" /></a>

ただまあ、やっぱ完璧ではないっすね。微妙にずれる文字があるんですよね……。

その原因が特定できれば……解決とも言いにくいかなあ？

原因次第では、フォントのメトリクスまでいじくらないといけないし……。そんならライセンスの問題とかあるし、それならIPAモナーフォントベースじゃなくて、IPAフォントから改変して、ライセンスをどうにかしたいしなあ。