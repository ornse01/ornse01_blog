---
title: 超漢字開発環境のPATHの話
date: 2015-02-16 22:21:09+09:00
tags: btron, 
---
Protocol Buffersコンパイラ開発中のお話。

<ol><li>パーサーの開発には、racc使ってまーす。</li>
<li>んでまあ、ビルドもテストもMakefile書いて処理してまーす。</li>
<li>そろそろぼちぼちCソースも出せるようにはなってきたぞー。</li>
<li>そんじゃあまあ、とりあえず実行ファイル作ってテストコード書いてみようか</li>
<li>いつものやつコピペして、実行ファイル用のMakefileにして</li>
<li>ついでに、元々のMakefileに書いてあった、racc走らせるのも、ruby側のテスト走らせるのも入れておくかー。</li>
<li>Makeがraccコマンド認識しねえ……</li></ol>

元々はきちんと動いていたんだから、Make側の原因じゃねえよなあ？

ってところで、調べてみたところ、原因は超漢字開発環境の<code>$(BD)/etc/makerules</code>

これPATH書き換えてるじゃねえか……。

まあ、/binとか/usr/binとかその他の普通にunix系の実行ファイル置いてそうな場所は足してあるから、大体は大丈夫なんだろうけど、問題は私の環境のraccねー。

と言っても、別に特別なことはしてなくて、rbenv使って、gemset切り分けてるだけなんですけど。

ただ、rbenvって仕組み的に、gemでインストールした実行ファイルを、<code>$(HOME)/.rbenv/shims</code>に置いてあって、そこにPATHを通して使うんですよねー。

んで、超漢字開発環境のmakerulesだとそれ消しちゃうから、gemでインストールしたraccは見えなくなっちゃう、と。

こりゃ、以前のmrubyのビルドがうまく行かなかったのもこれが原因っぽそうな感じ。

とりあえず、コンパイラ作成用と、超漢字アプリケーションビルド用とで、別のMakefileにしておいて解決ー。

まあ、現状とりあえずパーサーのBNFいじることはそんな無くなってきたし。最終的なユースケース考えたら、raccは不要な状態でリポジトリに入れる予定だから、そんな支障は無いはず。

とは言っても、ちょいと不便は不便かなあ？

んでも、他に解決方法はちょっと無いしなあ。

makerulesいじるのは論外。そもそも環境汚したくないからrbenv使ってるのに、開発環境に手を出すのは本末転倒。

Makefileにshims以下のPATHを追加するのもなんだかなー。あんま、ビルドに必要な環境を、必要以上に想定したくないし。超漢字開発環境だけでどうにかできるのが理想で、まあrubyぐらいいいだろう、とは思うが、rbenvまであることを想定っつーのもなー。まあ、Makefileに入れといたって、それほど支障は無いだろうけどさ。

makerules使わずにMakefileを書くとか？　rake使うとか？　まあ現実的っちゃ現実的だが、もとのファイルからコピペしまくる結果になるのがなー。共通部分はくくり出して別ファイルにしておきたいよなー。

まあ、makerules内で、PATH上書きするのはわからんでは無いんだよなあ。ユーザーの環境ごとにどうなってるかわからんし、影響範囲はmake中だけに限定できるから、必要最小限のものだけに上書きしちゃうのが手堅いっちゃ手堅いわけで。

とりあえず、他のビルドツールも検討してみようかねえ？　最有力はrakeだな。前使ったし。クロスコンパイラをバシッとファイルパスで指定しちゃえば、PATHとか気にせんでも平気だろうし。

まあ、ただビルドするだけなら、どんなツールでも簡単に行けるが、クロス開発環境で、ターゲット依存部分は切り出して別ファイルにして、複数のターゲットに対応できるようにして、とか考えていくと面倒なんだけど。

PMC製の開発環境って割とよく出来ててさー、超漢字開発環境で開発してたソースを、T-Shell用にビルドしようと思ったら、ソースをMakefileごと持って行ったらわいと簡単にビルドできてさー。

最低限そのくらいは実現しないとなんだが、結構面倒そうだよなー。
